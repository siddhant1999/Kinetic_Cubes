function parse_3d_file(e,r){switch(e.split(".").pop().toLowerCase()){case"stl":return parse_stl_bin(r);case"obj":return parse_obj(r);case"vf":return parse_vf(arrayBufferToString(r));default:return"Unknown file type"}}function arrayBufferToString(e,r,t){if("undefined"!=typeof TextDecoder)return new TextDecoder("utf-8").decode(e);for(var a=new Uint8Array(e),o=a.length,n="",l=0;l<o;l+=16383){var c=16383;l+16383>o&&(c=o-l),n+=String.fromCharCode.apply(null,a.subarray(l,l+c))}return n}function parse_stl_ascii(e){try{var r=arrayBufferToString(e),t=[],a=[],o={};r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=(r=r.replace(/\r/,"\n")).replace(/^solid[^\n]*/,"")).replace(/\n/g," ")).replace(/facet normal /g,"")).replace(/outer loop/g,"")).replace(/vertex /g,"")).replace(/endloop/g,"")).replace(/endfacet/g,"")).replace(/endsolid[^\n]*/,"")).replace(/facet/g,"")).replace(/\s+/g," ")).replace(/^\s+/,"");for(var n,l=0,c=r.split(" "),i=[],f=c.length/12-1,s=0;s<f;s++){i=[];for(var u=0;u<3;u++)f1=parseFloat(c[l+3*u+3]),f2=parseFloat(c[l+3*u+4]),f3=parseFloat(c[l+3*u+5]),null==(n=o[[f1,f2,f3]])&&(n=t.length,t.push(new Array(f1,f2,f3)),o[[f1,f2,f3]]=n),i.push(n);a.push(new Array(i[0],i[1],i[2])),l+=12}return{vertices:t,faces:a,colors:!1}}catch(e){return"Can't parse file"}}function parse_stl_bin(e){var r,t,a,o,n,l,c,i=[],f=[],s={};if(!e)return null;var u=arrayBufferToString(e.slice(0,80)).toLowerCase().indexOf("color"),p=new DataView(e,0),g=!0;u>-1&&(def_red_color=p.getUint8(u+6,!0)/31,def_green_color=p.getUint8(u+7,!0)/31,def_blue_color=p.getUint8(u+8,!0)/31);var h=80;try{var _=p.getUint32(h,!0)}catch(e){return"Can't parse file"}var y=84+50*_;if(e.byteLength!=y)return parse_stl_ascii(e);try{for(h+=4;_--;)h+=12,null==(r=s[[t=p.getFloat32(h,!0),a=p.getFloat32(h+4,!0),o=p.getFloat32(h+8,!0)]])&&(r=i.length,i.push(new Array(t,a,o)),s[[t,a,o]]=r),n=r,h+=12,null==(r=s[[t=p.getFloat32(h,!0),a=p.getFloat32(h+4,!0),o=p.getFloat32(h+8,!0)]])&&(r=i.length,i.push(new Array(t,a,o)),s[[t,a,o]]=r),l=r,h+=12,null==(r=s[[t=p.getFloat32(h,!0),a=p.getFloat32(h+4,!0),o=p.getFloat32(h+8,!0)]])&&(r=i.length,i.push(new Array(t,a,o)),s[[t,a,o]]=r),c=r,u>-1?(h+=12,face_color=p.getUint16(h,!0),32768==face_color||65535==face_color?(color_red=def_red_color,color_green=def_green_color,color_blue=def_blue_color):(g=!1,color_red=(31&face_color)/31,color_green=((992&face_color)>>5)/31,color_blue=((31744&face_color)>>10)/31),f.push(new Array(n,l,c,color_red,color_green,color_blue)),h+=2):(f.push(new Array(n,l,c)),h+=14);return s=null,{vertices:i,faces:f,colors:u>-1&&!g}}catch(e){return"Can't parse file"}}function parse_vf(e){var r=JSON.parse(e),t=[],a=[];try{var o=r.vertices.length;for(i=0;i<o;i++)t.push(new Array(r.vertices[i][0],r.vertices[i][1],r.vertices[i][2]));o=r.faces.length;for(i=0;i<o;i++)a.push(new Array(r.faces[i][0],r.faces[i][1],r.faces[i][2]));return{vertices:t,faces:a,colors:!1}}catch(e){return"Can't parse file"}}function geo_to_vf(e){var r=[],t=[],a=e.vertices.length;for(i=0;i<a;i++)r.push([e.vertices[i].x,e.vertices[i].y,e.vertices[i].z]);a=e.faces.length;for(i=0;i<a;i++)t.push([e.faces[i].a,e.faces[i].b,e.faces[i].c]);return{vertices:r,faces:t,colors:!1}}ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(e,r){if(void 0===e&&(e=0),void 0===r&&(r=this.byteLength),e=Math.floor(e),r=Math.floor(r),e<0&&(e+=this.byteLength),r<0&&(r+=this.byteLength),e=Math.min(Math.max(0,e),this.byteLength),(r=Math.min(Math.max(0,r),this.byteLength))-e<=0)return new ArrayBuffer(0);var t=new ArrayBuffer(r-e),a=new Uint8Array(t),o=new Uint8Array(this,e,r-e);return a.set(o),t});